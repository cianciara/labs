- hosts: all
  become: true
  tasks:
    - name: Install aptitude
      apt:
        name: aptitude
        state: latest
        update_cache: true

    - name: Update apt and install samba, smbclient, and winbind
      apt:
        pkg:
          - samba
          - smbclient
          - winbind
        state: latest
        update_cache: true

- hosts: all
  connection: local
  tasks:
    - name: copy id_rsa as id_rsa 
      copy:
        src: .ssh/id_rsa
        dest: /home/vagrant/.ssh/id_rsa
      tags:
        - simple_copy

- hosts: all
  tasks:
    - name: Change file ownership, group, and permissions
      ansible.builtin.file:
        path: /home/vagrant/.ssh/id_rsa
        owner: vagrant
        group: vagrant
        mode: '0600'

- hosts: all
  become: true
  tasks:
    - name: copy ansible hosts.ini file
      copy:
        src: hosts.ini
        dest: /etc/ansible/hosts.ini
      tags:
        - simple_copy

- name: 'Parse dictionary hosts'
  hosts: localhost
  vars:
    my_parsed_hosts:
      lab-1:
        name: 'samba'
        ansible_user: 'vagrant'
        ansible_host: '192.168.56.101'
        my_variable: false
      lab-2:
        name: 'nfs'
        ansible_user: 'vagrant'
        ansible_host: '192.168.56.102'
        my_variable: false

  tasks:
    - name: 'Add new hosts to this playbook from dictionary'
      ansible.builtin.add_host:
        name: '{{ item.value.name }}'
        ansible_user: '{{ item.value.ansible_user }}'
        ansible_host: '{{ item.value.ansible_host }}'
        my_variable: '{{ item.value.my_variable }}'
        groups:
          - 'lab'
      with_dict: '{{ my_parsed_hosts }}'
      when:
        - ('lab' not in groups)
        - ('lab' in item.value.name)
        - (item.value.name not in ansible_play_hosts_all)

- name: 'Use parsed dictionary hosts'
  hosts: lab
  tasks:
    - name: 'Print debug welcome message'
      ansible.builtin.debug:
        msg: >
          Node {{ ansible_host }} says welcome!

- hosts: all
  become: true
  tasks:
    - name: Edit /etc/hosts file
      lineinfile:
        path: /etc/hosts
        line: "{{ hostvars[item].ansible_host }} {{ hostvars[item].inventory_hostname }}"
        state: present
      loop: "{{ ansible_play_hosts_all }}"